version: '3.8'

services:
  tor-builder:
    build: .
    container_name: tor-static-builder
    volumes:
      # Mount output directory to persist build artifacts
      # Build script creates arch-specific subdirectories (e.g., output/amd64/)
      - ./output:/output
      # Optional: mount build cache to speed up rebuilds
      - tor-build-cache:/build
    environment:
      # Build and output directories (architecture is appended automatically)
      - BUILD_DIR=/build
      - OUTPUT_DIR=/output
      # Target architecture: amd64 (default) or arm64
      # Set via: ARCH=arm64 docker-compose up
      - ARCH=${ARCH:-amd64}

  android-builder:
    build:
      context: .
      dockerfile: Dockerfile.android
    container_name: tor-android-builder
    volumes:
      # Mount output directory to persist build artifacts
      # Build script creates android-arch subdirectories (e.g., output/android-arm64/)
      - ./output:/output
      # Optional: mount build cache to speed up rebuilds
      - android-build-cache:/build
    environment:
      # Build and output directories (android-arch is appended automatically)
      - BUILD_DIR=/build
      - OUTPUT_DIR=/output
      # Target architecture: arm64 (default), arm, x86, or x86_64
      # Set via: ARCH=arm64 docker-compose up android-builder
      - ARCH=${ARCH:-arm64}
      # Android API level (default: 21)
      - ANDROID_API=${ANDROID_API:-21}
      - ANDROID_NDK_HOME=/opt/android-ndk

  windows-builder:
    build:
      context: .
      dockerfile: Dockerfile.windows
    container_name: tor-windows-builder
    volumes:
      # Mount output directory to persist build artifacts
      # Build script creates windows-arch subdirectories (e.g., output/windows-amd64/)
      - ./output:/output
      # Optional: mount build cache to speed up rebuilds
      - windows-build-cache:/build
    environment:
      # Build and output directories (windows-arch is appended automatically)
      - BUILD_DIR=/build
      - OUTPUT_DIR=/output
      # Target architecture: amd64 (only supported architecture for Windows)
      - ARCH=${ARCH:-amd64}

volumes:
  # Named volume for build cache (optional)
  tor-build-cache:
    driver: local
  android-build-cache:
    driver: local
  windows-build-cache:
    driver: local